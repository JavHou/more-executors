version: 2.1

workflows:
  version: 2
  ci-cd:
    jobs:
    - tox:
        name: Python 2.6 tests
        toxenv: py26
        install_py26: true
        image_tag: 2.7.15-jessie
        filters: &ci_filters
          branches:
            ignore: gh-pages
          tags:
            only: /^v.*/
    - tox:
        name: Python 2.7 tests
        toxenv: py27
        image_tag: 2.7.15-stretch
        save_coverage: true
        filters:
          <<: *ci_filters
    - tox:
        name: Python 3.6 tests
        toxenv: py36
        save_coverage: true
        filters:
          <<: *ci_filters
    - tox:
        name: Static checks
        toxenv: static
        filters:
          <<: *ci_filters
    - tox:
        name: Build docs
        toxenv: docs
        # For pushing to gh-pages
        context: secrets
        post-steps:
        - run: scripts/push-docs
        filters:
          <<: *ci_filters
    - coveralls:
        name: Submit coverage results to Coveralls.io
        requires:
        - Python 2.7 tests
        - Python 3.6 tests
        context: secrets
        filters:
          <<: *ci_filters
    - release:
        name: Release to PyPI
        # For twine credentials
        context: secrets
        # Only release if all tests passed
        requires:
        - Python 2.6 tests
        - Python 2.7 tests
        - Python 3.6 tests
        - Static checks
        - Build docs
        filters:
          <<: *ci_filters

jobs:
  release:
    docker:
      - image: circleci/python:3.6.8-stretch
    working_directory: ~/repo
    steps:
    - checkout
    - run: pip install --user twine
    - run: python ./setup.py sdist bdist_wheel
    - run: >-
        if ! test -z "${TWINE_USERNAME}" && ! test -z "${CIRCLE_TAG}"; then
          ~/.local/bin/twine upload --skip-existing dist/*.tar.gz dist/*.whl;
        fi


  tox:
    parameters:
      toxenv:
        description: "tox environment to execute"
        type: string
      image_tag:
        description: tag of circleci/python image
        default: 3.6.8-stretch
        type: string
      install_py26:
        default: false
        type: boolean
      save_coverage:
        default: false
        type: boolean

    docker:
      - image: circleci/python:<< parameters.image_tag >>

    working_directory: ~/repo

    steps:
      - when:
          condition: <<parameters.install_py26>>
          steps:
            - run: >-
                sudo /bin/sh -c '
                echo "deb http://ppa.launchpad.net/fkrull/deadsnakes/ubuntu trusty main" >
                /etc/apt/sources.list.d/deadsnakes.list'
            - run: gpg --keyserver keyserver.ubuntu.com --recv-keys 'FF39 97E8 3CD9 69B4 09FB  24BC 5BB9 2C09 DB82 666C'
            - run: gpg --export DB82666C | sudo apt-key add -
            - run: sudo apt-get update
            - run: sudo apt-get remove python2.7
            - run: sudo rm -rf /usr/local
            - run: sudo apt-get install python2.6
            - run: >-
                curl -L https://github.com/pypa/get-pip/raw/3de61057f0037f4a12b4a3c6936e9ee91d07a811/2.6/get-pip.py -o /tmp/get-pip.py &&
                echo '02b9553a4fc36740ff183c40ce413d4ae840d17099e16a43ef4f7996230ea173  /tmp/get-pip.py' | sha256sum --check
            - run: sudo python2.6 /tmp/get-pip.py -vvv

      - restore_cache:
          key: v1-local-venv-<< parameters.image_tag >>

      - checkout

      - restore_cache:
          key: v1-cache-pip-{{ checksum "requirements.txt" }}-{{ checksum "test-requirements.txt" }}

      - run:
          name: install tox
          command: |
            pip install --user tox

      - save_cache:
          key: v1-local-venv-<< parameters.image_tag >>
          paths:
            - "~/.local"

      - run:
          name: Run tests
          command: |-
            ~/.local/bin/tox -e << parameters.toxenv >>

      - when:
          condition: <<parameters.save_coverage>>
          steps:
          - run:
              name: Prepare coverage file
              command: |-
                if test -f .coverage; then mv .coverage coverage.<< parameters.toxenv >>; fi

          - persist_to_workspace:
              root: .
              paths:
              - coverage.*

      - store_test_results:
          path: test-results

      - save_cache:
          key: v1-cache-pip-{{ checksum "requirements.txt" }}-{{ checksum "test-requirements.txt" }}
          paths:
            - "~/.cache/pip"


  coveralls:
    docker:
      - image: circleci/python:3.6.8-stretch

    working_directory: ~/repo

    steps:
      - run:
          name: install coveralls
          command: |
            pip install --user coveralls

      - checkout

      - attach_workspace:
          at: /tmp/workspace

      - run:
          name: Coveralls py27
          command: >-
            mv /tmp/workspace/coverage.py27 .coverage &&
            ~/.local/bin/coveralls --output coverage.json

      - run:
          name: Coveralls py36
          command: >-
            mv /tmp/workspace/coverage.py36 .coverage &&
            ~/.local/bin/coveralls --merge coverage.json
